# 服务熔断和降级的区别

① 服务熔断—>服务端：某个服务超时或异常，引起熔断，类似于保险丝(自我熔断)  
② 服务降级—>客户端：从整体网站请求负载考虑，当某个服务熔断或者关闭之后，服务将不再被调用，此时在客户端，我们可以准备一个 FallBackFactory ，返回一个默认的值(缺省值)。
会导致整体的服务下降，但是好歹能用，比直接挂掉强。触发原因不太一样，服务熔断一般是某个服务（下游服务）故障引起，而服务降级一般是从整体负荷考虑；管理目标的层次不太一样，
熔断其实是一个框架级的处理，每个微服务都需要（无层级之分），而降级一般需要对业务有层级之分（比如降级一般是从最外围服务开始）  

实现方式不太一样，服务降级具有代码侵入性(由控制器完成/或自动降级)，熔断一般称为自我熔断。

# 熔断、降级、限流

① 限流：限制并发的请求访问量，超过阈值则拒绝  
② 降级：服务分优先级，牺牲非核心服务（不可用），保证核心服务稳定；从整体负荷考虑  
③ 熔断：依赖的下游服务故障触发熔断，避免引发本系统崩溃；系统自动执行和恢复

Hystrix的三个重要概念？
1、服务降级
对方系统不可用了，需要给出一个终极解决办法，向调用方返回一个符合预期的、可处理的备选响应（fallback），而不是长时间的等待
或者抛出调用方无法处理的异常。
发生的情况：程序运行异常、超时、服务熔断出发服务降级、线程池/信号量打满也会导致服务降级
处理办法：
服务提供方设置自身调用超时时间的峰值，峰值内可以正常运行，超过了需要有兜底的方法处理，作为服务降级fallback，
在服务提供方的超时方法上
标注@HystrixCommand，此注解内写明超时后的处理方法，又能写明超时时长，然后在主启动类上标注@EnableCircuitBreaker启用注解
在配置超时后处理方法时可以使用@DefaultProperties(defaultFallback="")统一全局的异常处理方法
上面的处理办法是在服务提供方作的服务降级处理，除此之外，还可以在客户端做服务降级处理，在客户端做服务降级处理的办法：
实现@FeignClient标注的接口，在实现类里写服务降级的处理逻辑，这样做的话，即使服务提供方挂了，也不影响服务消费方给出友好提示信息

2、服务熔断
类比保险丝达到最大服务访问后，直接拒绝访问，然后调用服务降级的方法并返回友好提示
熔断机制是应对雪崩效应的一种微服务链路保护机制。当扇出链路的某个微服务出错不可用或者响应时间太长时，会进行服务的降级，进而
熔断该节点微服务的调用，快速返回错误的响应信息。当检测到该节点微服务调用响应正常后，恢复调用链路。
熔断类型：熔断打开、熔断关闭、熔断半开
断路器的三个重要参数：
快照时间窗：断路器确定是否打开需要统计一些请求和错误数据，而统计的时间范围就是快照时间窗，默认为最近的10秒
请求总数阈值：在快照时间窗内，必须满足请求总数阈值才有资格熔断。默认为20，也就是在10秒内，调用次数不足20次，即使
所有请求都超时或其他原因失败，断路器都不会打开。
错误百分比阈值：当请求总数在快照时间窗内超过了阈值，在默认设定50%阈值情况下，这时候就会讲断路器打开。
断路器开启的条件：默认10秒内超过20个请求，并且请求内50%以上的都失败，到达以上阈值，断路器将会开启
当开启的时候，所有的请求都不会进行转发
一段时间后（默认是5秒），这个时候断路器时半开状态，会让其中一个请求进行转发，失败继续开启，成功则断路器关闭
断路器打开之后，再有请求调用的时候，将不会调用主逻辑，而是直接调用降级fallback，通过断路器，
实现了自动发现错误并讲降级逻辑切换为主逻辑，减少响应延迟的效果。
主逻辑的恢复靠Hystrix实现的自动恢复功能。当断路器打开，对主逻辑进行熔断之后，hystrix会启动一个休眠时间窗，
在这个时间窗内，降级逻辑是临时的
主逻辑，当休眠时间窗到，断路器进入半开状态，释放一次请求到原来的主逻辑上，如果此次请求正常返回，那么断路器会闭合，主逻辑恢复，
如果这次请求依然有问题，断路器继续进入打开状态，休眠时间窗重新计时。

3、服务限流
秒杀高并发等操作，严禁拥挤，有序进行