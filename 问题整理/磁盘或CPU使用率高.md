# 磁盘占用率100%
```
https://mp.weixin.qq.com/s/GaXShwaowz6ip7z3aEUnlw
```
1 查看磁盘使用的大致情况```df -h```  
2 使用```du```命令来显示目录或文件所占用的磁盘空间大小  
```
// 列出当前目录或文件的总大小，并按倒序排序
du -sh /* | sort -nt
```

# 服务器CPU使用率高
## 解决思路
通过linux的```top```命令和jdk的```jstack```命令来排查当前系统CPU占用最多的线程

## 具体步骤
① 定位进程
```shell
# 每隔5秒显式进程的资源占用情况，并显示进程的命令行参数(默认只有进程名)
# P	以 CPU 占用率大小的顺序排列进程列表
# M	以内存占用率大小的顺序排列进程列表
top -c
```

② 查看进程中CPU占比最高的线程
```shell
top -H -p 3147
```

③ 将十进制的线程PID转成十六进制的，因为在线程堆栈信息中，线程号的展示就是十六进制的，转了之后便于查找
```shell
printf '%x\n' 3168
```

④ 用```jstack```导出进程堆栈信息
```shell
# 此命令会输出进程中所有的线程栈信息
jstack 3147

# 使用如下命令进行线程栈信息过滤，通过有问题的线程的16进制PID查找问题线程对应的栈信息
jstack 3147 | grep c60 -A 50

# 将线程栈信息重定向到文件中，再进行查询
jstack 3147 > jstack.log
```

⑤ 根据线程栈信息定位代码问题  

## 服务器CPU使用率高的其他情况
① 使用AtomicInteger、CountdownLatch等基于CAS的相关类时或者自己实现CAS时，当值修改失败时，会一直高速循环  
解决方案：（1）限制重试次数、（2）间隔一段时间后重试

② 程序死循环  
解决方案：在代码级别进行控制，保证代码质量和健壮性，流程代码需有退出循环的条件

③ tomcat并发量太高  
tomcat默认线程池数量200，一般不会更改为太高，大多数的请求都是快速响应。并发请求数暴增，超过tomcat的负载能力后，web容器中会堆积大量的请求，
会占用过多的CPU资源导致响应慢和卡顿  
解决方案：（1）限流、进行请求数量的控制、（2）负载均衡

④ 服务器端口被攻击  
解决方案：查看服务器网路的带宽情况和非法程序

⑤ Java虚拟机GC频繁  
当Java虚拟机频繁GC时，根据上述方法，查找到的CPU占用高的线程是JVM的GC线程，没有业务代码  
解决方案：（1）可以通过加大堆内存临时解决（2）生成堆dump，通过mat或```jprofile```排查大对象产生的代码  
一般生产环境，不会允许进行堆dump，此种情况，可以考虑上述方法，查找仅CPU占有率前几的线程栈信息或者CPU执行时间前几的线程栈信息
> 用```jstack```命令输出线程dump后，如果发现cpu负载高的是gc线程  
> ① 接着使用```jstat -gc pid 5000```打印gc日志进行确认，是否存在频繁GC情况  
> ② 如果存在频繁GC的情况，基本可以确定是垃圾回收的问题，只是还没有导致内存溢出  
> ③ 接着使用```jmap```命令强制进行一次内存dump，导出文件到本地目录






