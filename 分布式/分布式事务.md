---------------------------------------------------------
https://zhuanlan.zhihu.com/p/263555694
https://mp.weixin.qq.com/s/NrHIOzrz_Okwts4CIXZOkQ

---------------------------------------------------------

# 产生场景
1 跨JVM进程产生分布式事务  
典型的场景是微服务架构，多服务访问同一个数据库实例  
2 跨数据库实例产生分布式事务  
单体应用系统访问多个数据库实例时会产生分布式事务  

# CAP理论
1 一致性特点  
① 由于存在数据同步的过程，写操作的响应会有一定的延迟  
② 为了保证数据一致性会对资源暂时锁定，待数据同步完成释放锁定资源  
③ 如果请求数据同步失败的结点则会返回错误信息，一定不会返回旧数据  

2 可用性特点  
① 写入主数据库后要将数据同步到从数据库。
② 由于要保证从数据库的可用性，不可将从数据库中的资源进行锁定。
③ 即时数据还没有同步过来，从数据库也要返回要查询的数据，哪怕是旧数据，如果连旧数据也没有则可以按照约定返回一个默认信息，但不能返回错误或响应超时。

3 分区容错性特点  
① 主数据库向从数据库同步数据失败不影响读写操作  
② 其一个结点挂掉不影响另一个结点对外提供服务  

**分区容错性是分布式系统具备的基本能力**

4 CAP的组合  
① AP：这是很多分布式系统的选择。保证最终一致性即可  
② CP：zookeeper追求的就是强一致性  
③ CA：典型实现是关系型数据库  

# BASE理论
1 Basically Available（基本可用）  
2 Soft state（软状态）  
3 Eventually consistent（最终一致性）  

BASE理论是对AP的扩展，通过牺牲强一致性来获得可用性，当出现故障允许部分不可用但要保证核心功能可用，允许数据在一段时间内是不一致的，但最终达到一致状态。  

# 分布式事务解决方案之2PC
## 2PC
整个事务过程由事务管理器和参与者组成，事务管理器负责决策整个分布式事务的提交和回滚，事务参与者负责自己本地事务的提交和回滚  
1 准备阶段  
事务管理器给每个参与者发送 Prepare 消息，每个数据库参与者在本地执行事务，并写本地的 Undo/Redo 日志，此时事务没有提交。（Undo 日志是记录修改前的数据，用于数据库回滚，
Redo 日志是记录修改后的数据，用于提交事务后写入数据文件）  

2 提交阶段  
如果事务管理器收到了参与者的执行失败或者超时消息时，直接给每个参与者发送回滚（Rollback）消息；否则，发送提交（Commit）消息；参与者根据事务管理器的指令执行提交或者回滚操作，
并释放事务处理过程中使用的锁资源。注意：必须在最后阶段释放锁资源

问题：  
① 需要本地数据库支持XA协议  
② 资源锁需要等到两个阶段结束才释放，性能较差

### 2PC实现
#### XA方案

#### ```Seata实现```
通过对本地关系数据库的分支事务的协调来驱动完成全局事务，是工作在应用层的中间件。```Seata``` 把一个分布式事务理解成一个包含了若干分支事务的全局事务。
全局事务的职责是协调其下管辖的分支事务达成一致，要么一起成功提交，要么一起失败回滚。此外，通常分支事务本身就是一个关系数据库的本地事务  

具体执行流程：  
1 用户服务的 TM 向 TC 申请开启一个全局事务，全局事务创建成功并生成一个全局唯一的 XID  
2 用户服务的 RM 向 TC 注册分支事务，该分支事务在用户服务执行新增用户逻辑，并将其纳入 XID 对应全局事务的管辖  
3 用户服务执行分支事务，向用户表插入一条记录  
4 逻辑执行到远程调用积分服务时（XID 在微服务调用链路的上下文中传播）。积分服务的 RM 向 TC 注册分支事务，该分支事务执行增加积分的逻辑，并将其纳入 XID 对应全局事务的管辖  
5 积分服务执行分支事务，向积分记录表插入一条记录，执行完毕后，返回用户服务  
6 用户服务分支事务执行完毕  
7 TM 向 TC 发起针对 XID 的全局提交或回滚决议  
8 TC 调度 XID 下管辖的全部分支事务完成提交或回滚请求  

## 分布式事务解决方案之TCC


## 分布式事务解决方案之可靠消息最终一致性
### 本地消息表


## 分布式事务解决方案之最大努力通知
### 采用 MQ 的ACK机制




