# 负载均衡
Ribbon是客户端的负载均衡工具，会在注册中心上获取注册信息服务列表之后缓存到JVM本地，配合restTemplate实现客户端的远程调用
Ribbon集成于消费方进程，消费方通过它来获取到服务提供方的地址，然后再从这些地址中获取到一个合适的服务器
与Ribbon不同的是nginx是服务器端负载均衡，客户端所有请求都会交给nginx，然后由nginx实现转发请求，即负载均衡是由服务端实现的

Ribbon在工作时分成两步
第一步选择EurekaServer，它优先选择在同一个区域内负载较少的Server
第二步再根据用户指定的策略，在从Server获取到的服务注册列表中选择一个地址。
其中，Ribbon提供了多种策略，比如轮询、随机和根据响应时间加权
Ribbon默认自带的负载规则：都是实现了IRule接口的实现类，根据特定算法从服务列表中选取一个要访问的服务，
Ribbon自带七种：
RoundRibbonRule：轮询
RandomRule：随机
RetryRule：先按照RoundRibbonRule的策略获取服务，如果获取服务失败则在指定时间内会进行重试
WeightedResponseTimeRule：响应速度越快的实例选择权重越大，越容易被选择
BestAvailableRule：会过滤掉由于多次访问故障而处于断路器跳闸状态的服务，然后选择一个并发量最小的服务
AvailabilityFilteringRule：先过滤掉故障实例，再选择并发较小的实例
ZoneAvoidanceRule：默认规则，复合判断server所在区域的性能和server的可用性选择服务器

替换负载均衡的步骤：
1）在容器中new出一个IRule接口的实现类
2）在启动类上加@RibbonClient(name="服务提供方id",configuration=MySelfRule.class)

负载均衡算法（轮询）的原理是rest接口的请求数%服务器集群总数量=实际调用服务器位置下标，每次服务重启后rest接口计数从1开始
当总请求数为1时，1%2=1
2	2%2=0
.......
List<ServiceIntance> intances=discoveryClient.getInstances("服务id名");
根据上面取模的规则得到每次执行任务的实例的下标，然后调用list.get(index)得到这台实例的相关信息